<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Libros - Everyday Heroes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #d1d5db; /* gray-300 */
            background-color: #111827; /* gray-900 */
        }
        /* Estilos de la barra de desplazamiento */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Estilos de los títulos en el área de contenido */
        .content-area h2 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #374151;
            padding-bottom: 0.5rem;
            color: #ffffff;
        }
        .content-area h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
             color: #f3f4f6;
        }
        .content-area h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
             color: #e5e7eb;
        }
        .content-area p, .content-area li {
            line-height: 1.75;
            margin-bottom: 1rem;
        }
        .content-area ul {
            list-style-type: disc;
            padding-left: 2rem;
            margin-bottom: 1rem;
        }
        .content-area strong {
            color: #f9fafb;
        }

        /* Estilos para la navegación colapsable */
        .chapter-details summary {
            list-style: none; /* Oculta el marcador por defecto */
            cursor: pointer;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chapter-details summary::-webkit-details-marker {
            display: none; /* Oculta el marcador en Chrome/Safari */
        }
        .chapter-details .arrow {
            transition: transform 0.2s;
        }
        .chapter-details[open] .arrow {
            transform: rotate(90deg);
        }
        .subtopic-list {
            padding-left: 1rem;
            border-left: 1px solid #374151;
            margin-left: 0.5rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div class="flex h-screen">
        <aside class="w-full md:w-1/4 bg-gray-800 p-6 flex flex-col h-full shadow-lg">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-white mb-2">Everyday Heroes</h1>
                <p class="text-sm text-gray-400">Visor del Libro de Reglas</p>
            </header>
            
            <div class="relative mb-6">
                <input type="text" id="search-input" placeholder="Buscar en capítulos..." class="w-full bg-gray-700 text-white rounded-md py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>

            <nav id="chapter-nav" class="flex-grow overflow-y-auto pr-2">
                </nav>
        </aside>

        <main id="content-area" class="w-full md:w-3/4 p-8 md:p-12 overflow-y-auto content-area">
            <div id="welcome-message" class="text-center h-full flex flex-col justify-center items-center">
                <h2 class="text-4xl font-bold text-white">Bienvenido</h2>
                <p class="mt-4 text-lg text-gray-400">Selecciona un capítulo de la lista para comenzar a leer.</p>
                 <svg class="w-24 h-24 mt-8 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6.253v11.494m-9-5.747h18"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 18a6 6 0 100-12 6 6 0 000 12z" />
                </svg>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        // Modifica esta ruta para que apunte a la carpeta donde están tus archivos JS.
        // Ejemplo: 'data/libros/' o './' si están en la misma carpeta.
        const basePath = './'; 

        // Lista de archivos de capítulos a cargar. Agrega más archivos aquí.
        const chapterFiles = ['capitulo1.js', 'capitulo2.js', 'capitulo3.js'];
        // Nombres de las variables de capítulo (deben coincidir con los nombres de archivo sin la extensión)
        const chapterVarNames = ['capitulo1', 'capitulo2', 'capitulo3'];
        
        /**
         * Carga un script de forma asíncrona y devuelve una promesa.
         * @param {string} src - La ruta al archivo .js
         * @returns {Promise<void>}
         */
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Error al cargar el script: ${src}`));
                document.head.append(script);
            });
        }

        /**
         * Inicializa la aplicación después de cargar todos los datos.
         */
        async function main() {
            try {
                // Carga todos los scripts de los capítulos en paralelo usando la ruta base
                await Promise.all(chapterFiles.map(file => loadScript(basePath + file)));
                
                // Una vez cargados, los objetos de capítulo (capitulo1, etc.) estarán en el scope global (window)
                const chapters = chapterVarNames.map(name => window[name]).filter(Boolean).sort((a, b) => a.numero - b.numero);

                const chapterNav = document.getElementById('chapter-nav');
                const contentArea = document.getElementById('content-area');
                const searchInput = document.getElementById('search-input');
                const welcomeMessage = document.getElementById('welcome-message');

                /**
                 * Crea un slug a partir de un texto para usarlo como ID.
                 * @param {string} text 
                 * @returns {string}
                 */
                const createSlug = (text) => text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');

                /**
                 * Renderiza la navegación colapsable.
                 */
                function renderNav() {
                    const navContainer = document.createElement('div');
                    chapters.forEach(chapter => {
                        const subtopics = chapter.contenido.filter(item => item.tipo === 'h2');
                        
                        const details = document.createElement('details');
                        details.className = 'chapter-details mb-2';

                        details.innerHTML = `
                            <summary class="chapter-summary p-3 rounded-md hover:bg-gray-700 transition-colors duration-200 cursor-pointer flex justify-between items-center" data-chapter-id="${chapter.id}">
                                <span class="font-semibold text-white">${chapter.titulo}</span>
                                <svg class="arrow w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </summary>
                            <ul class="subtopic-list mt-2 space-y-1">
                                ${subtopics.map(subtopic => `
                                    <li>
                                        <a href="#${createSlug(subtopic.texto)}" class="subtopic-link block p-2 pl-4 text-sm rounded-md text-gray-400 hover:bg-gray-700/50 hover:text-white" data-chapter-id="${chapter.id}" data-section-id="${createSlug(subtopic.texto)}">
                                            ${subtopic.texto}
                                        </a>
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                        navContainer.appendChild(details);
                    });
                    chapterNav.innerHTML = '';
                    chapterNav.appendChild(navContainer);
                }

                /**
                 * Renderiza el contenido de un capítulo.
                 * @param {string} chapterId - El ID del capítulo.
                 * @param {string} [sectionId] - (Opcional) El ID de la sección a la que hacer scroll.
                 */
                function renderChapter(chapterId, sectionId = null) {
                    const chapter = chapters.find(c => c.id === chapterId);
                    if (!chapter) return;

                    welcomeMessage.style.display = 'none';

                    let htmlContent = `<h1 class="text-5xl font-extrabold text-white mb-8 border-b-4 border-indigo-500 pb-4">${chapter.titulo}</h1>`;

                    chapter.contenido.forEach(item => {
                        switch (item.tipo) {
                            case 'introduccion':
                                htmlContent += `<p class="text-lg text-gray-400 italic border-l-4 border-indigo-400 pl-4 mb-8">${item.texto}</p>`;
                                break;
                            case 'h2':
                                htmlContent += `<h2 id="${createSlug(item.texto)}">${item.texto}</h2>`;
                                break;
                            case 'h3':
                                htmlContent += `<h3>${item.texto}</h3>`;
                                break;
                            case 'h4':
                                htmlContent += `<h4>${item.texto}</h4>`;
                                break;
                            case 'parrafo':
                                htmlContent += `<p>${item.texto}</p>`;
                                break;
                            case 'lista':
                                htmlContent += `<ul class="list-disc list-inside bg-gray-800/50 p-4 rounded-lg mb-4">`;
                                item.items.forEach(li => { htmlContent += `<li>${li}</li>`; });
                                htmlContent += `</ul>`;
                                break;
                            case 'lista_definicion':
                                htmlContent += `<dl class="mb-4">`;
                                item.items.forEach(def => {
                                    htmlContent += `<dt class="font-semibold text-indigo-400 text-lg mt-4">${def.termino}</dt>`;
                                    htmlContent += `<dd class="pl-4 border-l-2 border-gray-700 mt-1 mb-2">${def.definicion}</dd>`;
                                });
                                htmlContent += `</dl>`;
                                break;
                            case 'tabla':
                            case 'tabla_destacada':
                                const tableClass = item.tipo === 'tabla_destacada' ? 'bg-indigo-900/20 border-indigo-500' : 'bg-gray-800/50 border-gray-700';
                                htmlContent += `<div class="overflow-x-auto my-6"><table class="min-w-full text-left rounded-lg overflow-hidden border ${tableClass}">`;
                                if (item.titulo) {
                                    htmlContent += `<caption class="text-lg font-semibold p-4 text-white bg-gray-700 text-left">${item.titulo}</caption>`;
                                }
                                htmlContent += `<thead class="bg-gray-700 text-gray-300 uppercase text-sm"><tr>`;
                                item.encabezados.forEach(header => { htmlContent += `<th class="p-4">${header}</th>`; });
                                htmlContent += `</tr></thead><tbody class="divide-y divide-gray-700">`;
                                item.filas.forEach(row => {
                                    htmlContent += `<tr class="hover:bg-gray-700/50 transition-colors duration-200">`;
                                    row.forEach(cell => { htmlContent += `<td class="p-4">${cell}</td>`; });
                                    htmlContent += `</tr>`;
                                });
                                htmlContent += `</tbody></table></div>`;
                                break;
                            case 'nota_especial':
                                htmlContent += `<div class="bg-gray-800 border-l-4 border-yellow-400 p-6 my-6 rounded-r-lg shadow-lg">`;
                                if (item.titulo) {
                                    htmlContent += `<h5 class="font-bold text-yellow-300 text-xl mb-2">${item.titulo}</h5>`;
                                }
                                htmlContent += `<p class="text-gray-400">${item.texto}</p></div>`;
                                break;
                            default:
                                htmlContent += `<p class="text-red-400">Tipo de contenido no soportado: ${item.tipo}</p>`;
                        }
                    });

                    contentArea.innerHTML = htmlContent;
                    
                    if (sectionId) {
                        setTimeout(() => { // Espera un momento para que el DOM se actualice
                            const sectionElement = document.getElementById(sectionId);
                            if (sectionElement) {
                                sectionElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    } else {
                        contentArea.scrollTop = 0;
                    }
                }
                
                function handleSearch() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const details = chapterNav.querySelectorAll('.chapter-details');
                    details.forEach(detail => {
                        const chapterTitle = detail.querySelector('.chapter-summary').textContent.toLowerCase();
                        const subtopics = Array.from(detail.querySelectorAll('.subtopic-link'));
                        let chapterMatch = chapterTitle.includes(searchTerm);
                        let subtopicVisibleCount = 0;

                        subtopics.forEach(link => {
                            const subtopicTitle = link.textContent.toLowerCase();
                            if (subtopicTitle.includes(searchTerm)) {
                                link.parentElement.style.display = 'block';
                                subtopicVisibleCount++;
                            } else {
                                link.parentElement.style.display = 'none';
                            }
                        });
                        
                        if (chapterMatch || subtopicVisibleCount > 0) {
                            detail.style.display = 'block';
                            if(searchTerm.length > 0) {
                                detail.open = true;
                            }
                        } else {
                            detail.style.display = 'none';
                        }
                        
                        if (searchTerm.length === 0) {
                            detail.open = false;
                        }

                    });
                }
                
                let currentlyActiveChapter = null;

                chapterNav.addEventListener('click', function(e) {
                    const summary = e.target.closest('.chapter-summary');
                    const subtopicLink = e.target.closest('.subtopic-link');

                    if (subtopicLink) {
                        e.preventDefault();
                        const chapterId = subtopicLink.dataset.chapterId;
                        const sectionId = subtopicLink.dataset.sectionId;
                        
                        if(currentlyActiveChapter !== chapterId){
                           renderChapter(chapterId, sectionId);
                           currentlyActiveChapter = chapterId;
                           document.querySelectorAll('.chapter-summary').forEach(s => s.classList.remove('bg-indigo-600'));
                           document.querySelector(`[data-chapter-id="${chapterId}"]`).classList.add('bg-indigo-600');
                        } else {
                            const sectionElement = document.getElementById(sectionId);
                            if (sectionElement) {
                                sectionElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }

                    } else if (summary) {
                        const chapterId = summary.dataset.chapterId;
                        if(currentlyActiveChapter !== chapterId){
                           renderChapter(chapterId);
                           currentlyActiveChapter = chapterId;
                           document.querySelectorAll('.chapter-summary').forEach(s => s.classList.remove('bg-indigo-600'));
                           summary.classList.add('bg-indigo-600');
                        }
                    }
                });
                
                searchInput.addEventListener('input', handleSearch);

                renderNav();

            } catch(error) {
                console.error("Error al inicializar la aplicación:", error);
                document.body.innerHTML = `<div class="text-red-500 text-center p-8">Error al cargar los datos de los capítulos. Revisa la consola para más detalles.</div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
